// Ene PM by Gameer - gameer.name
function ShowFindUser(){$("#fc_clist").hasClass("noneshow")?($("#fc_clist").removeClass("noneshow"),$("#fc_clist").addClass("thisshow")):($("#fc_clist").removeClass("thisshow"),$("#fc_clist").addClass("noneshow"))}function HideDialog(a){$('[data-chatblock="'+a+'"]').remove();for(var b=0;b<lcpm.length;b++)lcpm[b]==a&&lcpm.splice(b,1)}function ReadMess(a){0==$("#eneblock_"+a).attr("data-pmunread")&&$.ajax({type:"POST",url:"/engine/modules/ene_pm/ajax/read_mess.php",dataType:"json",data:{user_id:a},success:function(b){$("#unreadmessage"+a).remove(),$("#eneblock_"+a).attr("data-pmunread",1),console.log(b.suc)}})}function ShowChatUser(a){$.inArray(a,lcpm)==-1&&lcpm.push(a),$(".chatblocked").length<4?$('[data-chatblock="'+a+'"]').length?DLEalert("Этот диалог уже открыт.","Ошибка"):$.ajax({type:"GET",url:"/engine/modules/ene_pm/ajax/user_chat.php",dataType:"json",data:{user_id:a},success:function(b){$("body").append(b.block),$("[data-chatblock]").length>1&&$("#eneblock_"+a).css("left",270*($("[data-chatblock]").length-1)+30);var c=$("#allmessage_"+a);c.jScrollPane(),dialogblockarr[a]=c.data("jsp"),dialogblockarr[a].scrollToBottom(),c.bind("jsp-scroll-y",function(b,c,d,e){0==c&&d&&bindlock&&(update_msg(lcpm,!0),dialogblockarr[a].scrollByY(15,!1))}),$(".scrollersd"+a).jScrollPane(),$(function(){$('[data-chatblock="'+a+'"]').draggable({containment:"window",handle:"div.fc_tab_title",scroll:!1,cursor:"move"})}),$("#unreadmessage"+a).remove(),ReadMess(a),setInterval("update_msg(lcpm)",5e3)}}):DLEalert("У вас открыто макс. разрешенное кол-во диалогов","Ошибка")}function update_msg(a,b){var b=b||!1;if(a.length)for(var c=0;c<a.length;c++)if($("#eneblock_"+a[c]).length){if(b){var d=$("#eneblock_"+a[c]).attr("data-pmall"),e=$("#eneblock_"+a[c]).attr("data-from");if(!(d>e))return;e=d-e>=15?Number(e)+Number(15):d-e+Number(e)}else if($("#eneblock_"+a[c]).attr("data-from")>15)var e=$("#eneblock_"+a[c]).attr("data-from");else var e=15;if(b||e>15)var f=2;else var f=1;$.ajax({type:"POST",url:"/engine/modules/ene_pm/ajax/upd_mess.php",dataType:"json",data:{user_id:a[c],ajax_upd:e,msfg:f},success:function(a){"undefined"!=typeof a.message&&$("#putmess_"+a.id).html(a.message),e>15&&$("#eneblock_"+a.id).attr("data-from",e),dialogblockarr[a.id].reinitialise(),bindlock=0==dialogblockarr[a.id].getPercentScrolledY(),$("#eneblock_"+a.id).attr("data-pmall",a.allmessagenow),"undefined"!=typeof a.newmess&&(audio.play(),dialogblockarr[a.id].scrollToBottom(),$("#eneblock_"+a.id).attr("data-pmunread",0),ReadMess(a.id)),"undefined"!=typeof a.onlineblock?($("#inchatonline_"+a.id).remove(),$("#yserid_"+a.id).hasClass("onlinedeas")||$("#yserid_"+a.id).addClass("onlinedeas")):($("#inchatonline_"+a.id).length||$("#afteridoon_"+a.id).after('<div class="fc_tab_notify fc_tab_notify_unavail" id="inchatonline_'+a.id+'">'+a.nick+" сейчас не в сети</div>"),$("#yserid_"+a.id).hasClass("onlinedeas")&&$("#yserid_"+a.id).removeClass("onlinedeas"))},error:function(a,b,c){console.log("xml : "+a+" | status : "+b+" | error : "+c)}})}}function htmlSpecialChars(a,b){var d,c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};if("undefined"!=typeof b){b=[];for(d in c)b.push(d);for(b.reverse(),d=0;d<b.length;d++)a=a.replace(new RegExp(c[b[d]],"g"),b[d]);return a}for(d in c)a=a.replace(new RegExp(d,"g"),c[d]);return a}function ShowSmileP(a){$("#emoji_block_"+a).css("opacity","1"),$("#emoji_block_"+a).css("display","block")}function HideSmileP(a){$("#emoji_block_"+a).css("opacity","0"),$("#emoji_block_"+a).css("display","none")}function pasteHtmlAtCaret(a,b){var c,d;if(window.getSelection){if(c=window.getSelection(),c.getRangeAt&&c.rangeCount){d=c.getRangeAt(0),d.deleteContents();var e=document.createElement("div");e.innerHTML=a;for(var g,h,f=document.createDocumentFragment();g=e.firstChild;)h=f.appendChild(g);var i=f.firstChild;d.insertNode(f),h&&(d=d.cloneRange(),d.setStartAfter(h),b?d.setStartBefore(i):d.collapse(!0),c.removeAllRanges(),c.addRange(d))}}else if((c=document.selection)&&"Control"!=c.type){var j=c.createRange();j.collapse(!0),c.createRange().pasteHTML(a)}}function PsSmile(a,b){var c=document.getElementById("enepmtext_"+a).focus(),d="<img src='"+b+'\' class="emoji">';pasteHtmlAtCaret(d,c)}var audio=new Audio;audio.src="/uploads/new_msg.mp3",audio.load();var lcpm=[],dialogblockarr=[],bindlock=!1;$(function(){function c(){$("#fc_clist_filter").keyup(function(){var c=$(this).val();b!=c&&(clearInterval(a),a=setInterval(function(){d(c)},600))})}function d(c){clearInterval(a),$.post(dle_root+"engine/modules/ene_pm/ajax/search_user.php",{q:c},function(a){a&&($("#fc_contacts").empty(),$("#fc_contacts").html(a))}),b=c}var a=!1,b="";$("#fc_clist_filter").attr("autocomplete","off"),c(),$("#fc_clist").draggable({containment:"window",handle:"div.fc_tab_title",scroll:!1,cursor:"move"}),$("body").on("click","[id*=enepmtext_]",function(){var a=$(this).attr("data-messid");$("#placeholder_"+a).css("display","none")}),$("body").on("keydown","[id*=enepmtext_]",function(a){if(13==a.which){var b=$(this),c=$(this).attr("data-messid"),d=$("#eneblock_"+c).attr("data-time"),e=htmlSpecialChars($.trim($(b).html()));$(this).html(""),$.ajax({type:"POST",url:"/engine/modules/ene_pm/ajax/add_message.php",dataType:"json",data:{user_id:c,date_last:d,text_msg:e},success:function(a){$("#putmess_"+c).append(a.message),$("#eneblock_"+c).attr("data-time",a.time),dialogblockarr[c].reinitialise(),dialogblockarr[c].scrollToBottom(),b.html("")},error:function(a,c,d){console.log("xml : "+a+" | status : "+c+" | error : "+d),b.html("")}})}})});